<% content_for :title, "#{@location.name} - CD Collection" %>

<%
  slot_labels_a = %w[A B C D]
  slot_labels_b = %w[E F G H]
%>

<style>
  @keyframes flipOutRight {
    from { transform: rotateY(0deg); opacity: 1; }
    to { transform: rotateY(-90deg); opacity: 0; }
  }
  @keyframes flipOutLeft {
    from { transform: rotateY(0deg); opacity: 1; }
    to { transform: rotateY(90deg); opacity: 0; }
  }
  @keyframes flipInLeft {
    from { transform: rotateY(90deg); opacity: 0; }
    to { transform: rotateY(0deg); opacity: 1; }
  }
  @keyframes flipInRight {
    from { transform: rotateY(-90deg); opacity: 0; }
    to { transform: rotateY(0deg); opacity: 1; }
  }
  .flip-out-right { animation: flipOutRight 0.3s ease-in forwards; }
  .flip-out-left { animation: flipOutLeft 0.3s ease-in forwards; }
  .flip-in-left { animation: flipInLeft 0.3s ease-out forwards; }
  .flip-in-right { animation: flipInRight 0.3s ease-out forwards; }
  .binder-page { perspective: 1000px; transform-style: preserve-3d; }
</style>

<div class="p-4 w-full">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <%= link_to cd_collection_path, class: "text-gray-500 hover:text-gray-700 text-sm mb-2 inline-block" do %>
        &larr; Back to CD Collection
      <% end %>
      <h1 class="font-bold text-4xl"><%= @location.name %></h1>
      <p class="text-gray-500 mt-1">
        <%= pluralize(@media_items.count, "CD") %> in this binder
      </p>
    </div>
    <%= link_to "Add CDs", cd_collection_add_path(@location), class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors" %>
  </div>

  <!-- Binder View -->
  <div class="max-w-xl mx-auto"
       data-controller="cd-binder"
       data-cd-binder-total-pages-value="<%= @pages_per_binder %>"
       data-location-id="<%= @location.id %>"
       data-action="keydown->cd-binder#keydown"
       tabindex="0">

    <!-- Page Navigation -->
    <div class="flex items-center justify-between mb-4">
      <button data-cd-binder-target="prevBtn"
              data-action="click->cd-binder#prev"
              class="flex items-center gap-2 px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        <span>Prev</span>
      </button>

      <div class="flex items-center gap-2">
        <span data-cd-binder-target="pageNumber" class="text-gray-700 font-medium">Page 1 of <%= @pages_per_binder %></span>
        <select class="px-2 py-1 border border-gray-300 rounded text-sm"
                data-action="change->cd-binder#goToPage">
          <% (1..@pages_per_binder).each do |page_num| %>
            <option value="<%= page_num %>"><%= page_num %></option>
          <% end %>
        </select>
      </div>

      <button data-cd-binder-target="nextBtn"
              data-action="click->cd-binder#next"
              class="flex items-center gap-2 px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
        <span>Next</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>

    <!-- Page Content -->
    <div class="binder-page">
      <% (1..@pages_per_binder).each do |page_num| %>
        <% ['A', 'B'].each_with_index do |side, side_idx| %>
          <% slot_labels = side == 'A' ? slot_labels_a : slot_labels_b %>
          <% is_first = page_num == 1 && side == 'A' %>

          <!-- Page <%= page_num %> Side <%= side %> -->
          <div class="<%= is_first ? '' : 'hidden' %> bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-300 rounded-lg shadow-lg p-4"
               data-cd-binder-target="page">

            <!-- Side header with flip button -->
            <div class="flex justify-between items-center mb-4">
              <span data-cd-binder-target="sideLabel" class="text-lg font-medium text-gray-700">Side <%= side %></span>
              <button data-cd-binder-target="flipBtn"
                      data-action="click->cd-binder#flip"
                      class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm font-medium">
                Flip to Side <%= side == 'A' ? 'B' : 'A' %>
              </button>
            </div>

            <!-- 2x2 CD Grid -->
            <div class="grid grid-cols-2 gap-3">
              <% (0..3).each do |slot| %>
                <% pos = slot_position_for(page_num, side, slot) %>
                <% media_item = @items_by_slot[pos] %>
                <% slot_label = slot_label_for(pos) %>

                <div class="aspect-square relative group">
                  <% if media_item %>
                    <%= link_to media_item_path(media_item), class: "block w-full h-full" do %>
                      <div class="w-full h-full rounded-lg bg-gradient-to-br from-slate-400 to-slate-600 shadow-md overflow-hidden relative group-hover:ring-4 group-hover:ring-blue-400 transition-all">
                        <% if media_item.release&.cover_image&.attached? %>
                          <%= image_tag media_item.release.cover_image, class: "w-full h-full object-cover" %>
                        <% else %>
                          <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-600 to-gray-800">
                            <svg class="w-12 h-12 text-white/30" fill="currentColor" viewBox="0 0 20 20">
                              <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="1" fill="none"/>
                              <circle cx="10" cy="10" r="2" fill="currentColor"/>
                            </svg>
                          </div>
                        <% end %>
                        <div class="absolute top-2 left-2 bg-black/70 text-white text-sm px-2 py-0.5 rounded">
                          <%= slot_label %>
                        </div>
                      </div>
                    <% end %>
                    <div class="absolute z-20 -bottom-2 left-0 right-0 text-center">
                      <span class="inline-block px-2 py-1 bg-gray-900/90 text-white text-xs rounded truncate max-w-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <%= truncate(media_item.display_title || "Unknown", length: 30) %>
                      </span>
                    </div>
                  <% else %>
                    <div class="w-full h-full rounded-lg border-2 border-dashed border-gray-300 bg-white/50 flex flex-col items-center justify-center">
                      <span class="text-2xl font-bold text-gray-300"><%= slot_label %></span>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Quick Page Navigation -->
    <div class="mt-4 flex justify-center gap-1">
      <% (1..@pages_per_binder).each do |page_num| %>
        <button class="w-4 h-4 rounded-sm <%= page_num == 1 ? 'bg-blue-600' : 'bg-gray-300' %> hover:bg-blue-500 transition-colors relative group"
                data-action="click->cd-binder#jumpToPage"
                data-page="<%= page_num %>">
          <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
            Page <%= page_num %>
          </span>
        </button>
      <% end %>
    </div>

    <p class="text-center text-xs text-gray-400 mt-2">Arrow keys to change page, Space or F to flip</p>
  </div>

  <!-- Reorder List -->
  <div class="mt-12 max-w-4xl mx-auto">
    <h3 class="font-bold text-xl mb-4">All CDs in this Binder</h3>
    <%= render partial: "cd_collection/cd_sorter" %>
  </div>
</div>
