<div class="max-w-6xl px-4 py-8">
  <h1 class="font-bold text-4xl mb-8">Search Discogs</h1>

  <%= form_with url: discogs_path, method: :get, class: "mb-8" do |f| %>
    <div class="flex gap-4 mb-4">
      <div class="flex-1">
        <%= f.text_field :q,
          value: @query,
          placeholder: "Search for artist, album, or track...",
          id: "search-input",
          class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>

      <div>
        <%= f.select :type,
          options_for_select([
            ["All Types", ""],
            ["Release", "release"],
            ["Master", "master"],
            ["Artist", "artist"],
            ["Label", "label"]
          ], @type_filter),
          {},
          class: "px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>

      <div>
        <%= f.select :format,
          options_for_select([
            ["All Formats", ""],
            ["Vinyl", "vinyl"],
            ["CD", "cd"]
          ], @format_filter),
          {},
          class: "px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>

      <div>
        <%= f.submit "Search", class: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer" %>
      </div>
    </div>
  <% end %>

  <% if flash[:alert] %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <% if @query.present? %>
    <div class="mb-4">
      <p class="text-gray-600">
        Found <%= @results.length %> results for "<%= @query %>"
        <% if @type_filter.present? || @format_filter.present? %>
          (filtered by:<%= " #{@type_filter}" if @type_filter.present? %><%= ", #{@format_filter}" if @format_filter.present? %>)
        <% end %>
      </p>
    </div>

    <% if @results.any? %>
      <div id="results-list" class="grid gap-4">
        <% @results.each do |result| %>
          <div class="result-item border border-gray-200 rounded-lg p-4 hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow cursor-pointer"
               tabindex="0"
               <% if result["type"] == "release" %>data-url="<%= discog_path(result["id"]) %>"<% end %>>
            <div class="flex gap-4">
              <% if result["thumb"].present? %>
                <div class="flex-shrink-0">
                  <%= image_tag result["thumb"],
                    alt: result["title"],
                    class: "w-24 h-24 object-cover rounded" %>
                </div>
              <% end %>

              <div class="flex-1">
                <h3 class="font-bold text-xl mb-2">
                  <% if result["type"] == "release" %>
                    <%= link_to result["title"], discog_path(result["id"]), class: "text-blue-600 hover:text-blue-800", tabindex: "-1" %>
                  <% elsif result["type"] == "master" %>
                    <%= result["title"] %>
                  <% else %>
                    <%= result["title"] %>
                  <% end %>
                </h3>

                <div class="text-sm text-gray-600 space-y-1">
                  <p><strong>Type:</strong> <%= result["type"]&.titleize %></p>

                  <% if result["year"].present? %>
                    <p><strong>Year:</strong> <%= result["year"] %></p>
                  <% end %>

                  <% if result["label"].present? && result["label"].any? %>
                    <p><strong>Label:</strong> <%= result["label"].join(", ") %></p>
                  <% end %>

                  <% if result["country"].present? %>
                    <p><strong>Country:</strong> <%= result["country"] %></p>
                  <% end %>

                  <% if result["format"].present? && result["format"].any? %>
                    <p><strong>Format:</strong> <%= result["format"].join(", ") %></p>
                  <% end %>

                  <% if result["genre"].present? && result["genre"].any? %>
                    <p><strong>Genre:</strong> <%= result["genre"].join(", ") %></p>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <script>
        (function() {
          const resultsList = document.getElementById('results-list');
          if (!resultsList) return;

          const items = resultsList.querySelectorAll('.result-item');
          const searchInput = document.getElementById('search-input');

          // Auto-focus first result after search
          if (items.length > 0) {
            requestAnimationFrame(() => items[0].focus());
          }

          // Allow arrow down from search input to jump to results
          if (searchInput) {
            searchInput.addEventListener('keydown', function(e) {
              if (e.key === 'ArrowDown' && items.length > 0) {
                e.preventDefault();
                items[0].focus();
              }
            });
          }

          // Handle arrow key navigation and Enter
          resultsList.addEventListener('keydown', function(e) {
            const focused = document.activeElement;
            if (!focused.classList.contains('result-item')) return;

            const itemsArray = Array.from(items);
            const currentIndex = itemsArray.indexOf(focused);

            if (e.key === 'ArrowDown') {
              e.preventDefault();
              const nextIndex = Math.min(currentIndex + 1, items.length - 1);
              items[nextIndex].focus();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              if (currentIndex === 0 && searchInput) {
                searchInput.focus();
              } else {
                const prevIndex = Math.max(currentIndex - 1, 0);
                items[prevIndex].focus();
              }
            } else if (e.key === 'Enter') {
              const url = focused.dataset.url;
              if (url) {
                window.location.href = url;
              }
            }
          });

          // Allow clicking anywhere on the result item to navigate
          items.forEach(function(item) {
            item.addEventListener('click', function(e) {
              if (e.target.tagName === 'A') return; // Let links handle themselves
              const url = item.dataset.url;
              if (url) {
                window.location.href = url;
              }
            });
          });
        })();
      </script>
    <% else %>
      <div class="text-center py-8 text-gray-500">
        <p>No results found. Try a different search query.</p>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-12 text-gray-500">
      <p class="text-lg">Enter a search query above to find albums, artists, and releases on Discogs.</p>
    </div>
    <script>
      document.getElementById('search-input').focus();
    </script>
  <% end %>
</div>
